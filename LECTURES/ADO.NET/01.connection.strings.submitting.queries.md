# ADO.Net Connection

- Simple Connection Application
```<C#>
    SqlConnection connection = new SqlConnection(cnnString);
    connection.Open();
    ResultText = GetconnectionInformation(connection);
    connection.Close();
    connection.Dispose();
```

- Using method
```<C#>
    using (SqlConnection connection = new SqlConnection(ConnectionString)) {
        connection.Open();
        /// Don't need Close() and Dispose()
        Resulttext = GetConnectionInformation();
    }
```

- Error Handling
```<C#>
try {
    using (SqlConnection connection = new SqlConnection(ConnectionString)) {
        using (SqlCommand = new SqlCommand(sql, connection)) {
            connection.Open();
            RowAffected = (int)cmd.ExecuteScalar();
        }
    }
}
catch (Exception ex) {
    Resulttext = ex.ToString();
}
```

- The best place to create a connection string is https://connectionstrings.com

- Retrieving query or insert
var cmd = new SqlCommand(sql, connection);
cmd.ExecuteNonQuery();
cmd.ExecuteScalar();

- Performing an Action Query - Insert, Update, or delete
```<C#>
string sql = "INSERT INTO...(@ProductName)";
try {
    using (SqlConnection connection = new SqlConnection(ConnectionString)) {
        using (SqlTransaction transaction = connection.BeginTransaction()) {
            try {
                using (SqlCommand = new SqlCommand(sql, connection)) {
                    cmd.Transaction = transaction;
                    cmd.CommandType = CommandType.Text; /// CommandType.StoredProcedure
                    /// INPUT Parameter
                    cmd.Parameters.Add(new SqlParameter("@ProductName", "New Product"));
                    /// OUTPUT Parameter
                    cmd.Parameters.Add(new SqlParameter {
                        ParameterName = "@ProductId",
                        Value = 1,
                        DbType = DbType.Int32,
                        Direction = ParameterDirection.Output
                    });
                    connection.Open();
                    RowAffected = (int)cmd.ExecuteScalar();
                    var productId = (int)cmd.Parameters["@ProductId"].Value;
                    ResultText = RowsAffected.ToString();
                    /// Second Command
                    cmd.Parameters.Clear() /// Clear previous parameters
                    transaction.Commit();
                }
            }
            catch (Exception ex) {
                transaction.Rollback();
            }
        }
    }
} catch (Exception ex) {
    ResultText = ex.ToString();
}
```

- SqlDataReader
-- Forward-Only cursor
-- Fastest Method of reading data
-- Be sure to close use using block
```<C#>
   using (SqlConnection connection = new SqlConnection(ConnectionString)) {
        using (SqlTransaction transaction = connection.BeginTransaction()) {
            try {
                using (SqlCommand = new SqlCommand(sql, connection)) {
                    cmd.Transaction = transaction;
                    cmd.CommandType = CommandType.Text; /// CommandType.StoredProcedure
                    /// INPUT Parameter
                    cmd.Parameters.Add(new SqlParameter("@ProductName", "New Product"));
                    /// OUTPUT Parameter
                    cmd.Parameters.Add(new SqlParameter {
                        ParameterName = "@ProductId",
                        Value = 1,
                        DbType = DbType.Int32,
                        Direction = ParameterDirection.Output
                    });
                    connection.Open();
                    using (SqlDataReader dataReader = cmd.ExecuteReader(CommandBehavior.CloseConnection)) {
                        while (dataReader.Read()) {
                            sb.AppendLine("Product" + dataReader["ProductId"].ToString());
                            sb.AppendLine("Product" + Convert.ToDateTime(dataReader["IntroductionDate"]).ToShortDateString());
                            sb.AppendLine("Product" + Convert.ToDecimal(dataReader["Price"]).ToShortDateString("c"));
                        }
                    }
                    transaction.Commit();
                }
            }
            catch (Exception ex) {
                transaction.Rollback();
            }
        }
    } 
```

- DataReader Methods
-- GetOrdinal(string) => Returns the column Number => returns Integer
--- GetInt32(int)
--- GetString(int)
--- GetDateTime(int) => (DateTime?)null
--- IsDbNull(int)
--- GetFieldValue<DataType>(int) => call with GetOrdinal(string)
---- GetFieldValue does not work on nullable fields

-- Create Extension Methods
```<C#>
    public static T GetFieldValue<T>(this SqlDataReader dataReader, string name) {
        T returnValue = default;
        if (dataReader[name].Equals(DBNull.Value)) {
            returnValue = (T)dataReader[name];
        }
        return returnValue;
    }
```

- MARS or Multiple Result Sets
-- Two or More select statements are returned or passed to a Sql Command using one SQL Call
```<C#>
    var sql = "SQL1;SQL2;SQL3"; /// Separated by semi-colons
    using (SqlConnection connection = new SqlConnection(ConnectionString)) {
        using (SqlTransaction transaction = connection.BeginTransaction()) {
            try {
                using (SqlCommand = new SqlCommand(sql, connection)) {
                    cmd.Transaction = transaction;
                    cmd.CommandType = CommandType.Text; /// CommandType.StoredProcedure
                    /// INPUT Parameter
                    cmd.Parameters.Add(new SqlParameter("@ProductName", "New Product"));
                    /// OUTPUT Parameter
                    cmd.Parameters.Add(new SqlParameter {
                        ParameterName = "@ProductId",
                        Value = 1,
                        DbType = DbType.Int32,
                        Direction = ParameterDirection.Output
                    });
                    connection.Open();
                    using (SqlDataReader dataReader = cmd.ExecuteReader(CommandBehavior.CloseConnection)) {
                        while (dataReader.Read()) {
                            sb.AppendLine("Product" + dataReader["ProductId"].ToString());
                            sb.AppendLine("Product" + Convert.ToDateTime(dataReader["IntroductionDate"]).ToShortDateString());
                            sb.AppendLine("Product" + Convert.ToDecimal(dataReader["Price"]).ToShortDateString("c"));
                        }
                        dataReader.NextResult(); /// Moves to the Next SQL2 Results
                        while (dataReader.Read()) {
                            sb.AppendLine("Product" + dataReader["ProductId"].ToString());
                            sb.AppendLine("Product" + Convert.ToDateTime(dataReader["IntroductionDate"]).ToShortDateString());
                            sb.AppendLine("Product" + Convert.ToDecimal(dataReader["Price"]).ToShortDateString("c"));
                        }
                        dataReader.NextResult(); /// Moves to the Next SQL3 Results
                        while (dataReader.Read()) {
                            sb.AppendLine("Product" + dataReader["ProductId"].ToString());
                            sb.AppendLine("Product" + Convert.ToDateTime(dataReader["IntroductionDate"]).ToShortDateString());
                            sb.AppendLine("Product" + Convert.ToDecimal(dataReader["Price"]).ToShortDateString("c"));
                        }
                    }
                    transaction.Commit();
                }
            }
            catch (Exception ex) {
                transaction.Rollback();
            }
        }
    } 
```

- Handling Exceptions
-- catch SqlException
-- Create SqlExceptionManager class
```<C#>
    Publish(ex, cmd);
    Creates a custom exception object
    SqlServerDataException Class
        - SQL statement
        - Command Parameters
        - Connection string (minus User ID and Password)
        - SQL Server Errors
    SqlServerExceptionManager.Publish(ex, cmd, "Error in ExceptionViewModel.GatherExceptionInformation()")
    ResultText = SqlServerExceptionManager.LastException.ToString()

    SqlConnection connection
    SqlCommand command
    try {


    } 
    catch (SqlException ex) {
        SqlServerExceptionManager.Publish(ex, cmd, "Error in ExceptionViewModel.GatherExceptionInformation()");
        ResultText = SqlServerExceptionManager.LastException.ToString();
    }
    finally {
        if (connection != null) {
            connection.Close();
            connection.Dispose();
        }
    }
```

- SqlServerExceptionManager Class
```<C#>
    public virtual void Publish(Exception ex, SqlCommand cmd, string exceptionMessage) {
        LastException = ex;
        if (cmd != null) {
            LastException = CreateDbException(ex, cmd, null);
            System.Diagnostic.Debug.WriteLine(ex.ToString());
        }
    }

    public virtual void SqlServerDataException CreateDbException(Exception ex, SqlCommand command, string message) {
        SqlServerDataException exc;
        message = string.IsNullOrEmpty(exceptionMessage) ? string.Empty : message;
        exc = new SqlServerDataException(message + ex.Message, ex)
        {
            ConnectionString = cmd.Connection.ConnectionString,
            Database = cmd.Connection.Database,
            SQL = cmd.CommandText,
            commandParameters = cmd.Parameters,
            WorkstationId = Environment.MachineName
        };
        return exc;
    }

    public override string ToString() {
        StringBuilder sb = new StringBuilder();
        sb.AppendLine("blah...blah...");
        return sb.ToString();
    }
```

- SqlConnectionStringBuilder
```<C#>
    SqlConnectionStringBuilder builder = new SqlConnectionStringBuilder(ConnectionString);
    sb.AppendLine(builder.ApplicationName);
    sb.AppendLine(builder.Database);
    sb.AppendLine(builder.Password);
    sb.AppendLine(builder.UserId);
    sb.AppendLine(builder.IntegratedSecurity);

    /// Creates a new connection string
    string connectionString = builder.ToString();
```

- SqlCommandBuilder
```<C#>
    - Create a command object with SELECT
    - Infers INSERT, UPDATE, DELETE from SELECT
    - Creates Parameters Collection
    /// Must fill in all Parameters that are generated
    SqlCommandBuilder builder = new SqlCommandBuilder(dataAdapter);
    /// Pass true to generate parameters names matching column names
    builder.GetInsertCommand(true).CommandText;
    builder.GetUpdateCommand(true).CommandText;
    builder.GetDeleteCommand(true).CommandText;
    using (SqlConnection connection = new SqlConnection(ConnectionString)) {
        try {
            using (SqlAdapter dataAdapter = new SqlAdapter(sql, connection)) {
                DataTable dt = new DataTable();
                dt.Fill(dt);
                using (SqlCommandBuilder builder = new SqlCommandBuilder(dataAdapter)) {
                    cmd.CommandType = CommandType.Text; /// CommandType.StoredProcedure
                    /// INPUT Parameter
                    cmd.Parameters.Add(new SqlParameter("@ProductName", "New Product"));
                    /// OUTPUT Parameter
                    cmd.Parameters.Add(new SqlParameter {
                        ParameterName = "@ProductId",
                        Value = 1,
                        DbType = DbType.Int32,
                        Direction = ParameterDirection.Output
                    });
                    cmd.Connection = conneciton;
                    cmd.ExecuteNonQuery();
                }
            }
        }
        catch (Exception ex) {
            transaction.Rollback();
        }
    } 
```

- ADO.NET Wrapper Class
-- Creates your own
-- Performance is great
-- Dynamic SQL or Stored Procedure
-- Create List<T> with a single line of code
-- Can use [Column] attribute
-- Validation using Data Annotations and/or custom code
-- Transactions
